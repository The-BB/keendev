#
# This is free software, licensed under the GNU General Public License v2.
# See /LICENSE for more information.
#
# mpd uses signalfd() and epoll() in some strange way, so we disabled it

include $(TOPDIR)/rules.mk

PKG_NAME:=mpd
PKG_VERSION:=0.20.8
PKG_RELEASE:=1

PKG_SOURCE:=$(PKG_NAME)-$(PKG_VERSION).tar.xz
PKG_SOURCE_URL:=http://www.musicpd.org/download/mpd/0.20/
PKG_HASH:=7d177f29663c4a0997413401e52bbf11d2bb472773bbcf9294f839c4b8751e35
PKG_MAINTAINER:=Ted Hess <thess@kitschensync.net>

PKG_LICENSE:=GPL-2.0
PKG_LICENSE_FILES:=COPYING

PKG_BUILD_DIR:=$(BUILD_DIR)/$(PKG_NAME)-$(BUILD_VARIANT)-zyx/$(PKG_NAME)-$(PKG_VERSION)
PKG_UNPACK=$(HOST_TAR) -C $(PKG_BUILD_DIR) --strip-components=1 -xpJf $(DL_DIR)/$(PKG_SOURCE)

PKG_BUILD_PARALLEL:=1

PKG_CONFIG_DEPENDS:= \
	CONFIG_IPV6 \

PKG_INSTALL:=1

include $(INCLUDE_DIR)/package.mk
include $(INCLUDE_DIR)/nls.mk

define Package/mpd-zyx/Default
  SECTION:=sound
  CATEGORY:=Sound
  TITLE:=Music Player Daemon
  URL:=http://www.musicpd.org/
  DEPENDS:= +glib2 +libcurl +libpthread +libmpdclient +libstdcpp $(ICONV_DEPENDS) \
	    +libflac +BUILD_PATENTED:libmad +libvorbisidec +AUDIO_SUPPORT:alsa-lib \
            +boost +boost-container +libexpat
  CONFLICTS:=mpd
endef

define Package/mpd-zyx/Default/description
 Music Player Daemon (MPD) is a flexible, powerful, server-side
 application for playing music. It is typically controlled over a
 network using one of it's many clients including mpc (console),
 gmpc (gnome), phpmp (php), etc...
endef

define Package/mpd-full-zyx
$(call Package/mpd-zyx/Default)
  TITLE+= (full)
  DEPENDS+= \
	+libaudiofile +BUILD_PATENTED:libfaad2 +libffmpeg +libid3tag \
	+libmms +libogg +libsndfile +libvorbis +libupnp
  PROVIDES:=mpd
  VARIANT:=full
endef

define Package/mpd-full-zyx/description
$(call Package/mpd-zyx/Default/description)
 .
 This package contains a full-blown Music Player Daemon.
endef

define Package/mpd-full-zyx/conffiles
/opt/etc/mpd.conf
endef

define Package/mpd-mini-zyx
$(call Package/mpd-zyx/Default)
  TITLE+= (mini)
  PROVIDES:=mpd
  VARIANT:=mini
endef

define Package/mpd-mini-zyx/description
$(call Package/mpd-zyx/Default/description)
 .
 This package contains a minimal Music Player Daemon, with support for
 only Flac, MP3 & OGG media types & only file: & http: protocols.
endef

define Package/mpd-mini-zyx/conffiles
/opt/etc/mpd.conf
endef

define Package/mpd-avahi-service-zyx
$(call Package/mpd-zyx/Default)
  TITLE+= (Avahi service)
  DEPENDS+=+avahi-daemon
endef

define Package/mpd-avahi-service-zyx/description
$(call Package/mpd-zyx/Default/description)
 .
 This package contains the service definition for announcing the
 Music Player Daemon service via mDNS/DNS-SD.
endef

define Package/mpd-avahi-service-zyx/conffiles
/opt/etc/avahi/services/mpd.service
endef

TARGET_CFLAGS += -ggdb3
TARGET_LDFLAGS += -Wl,-rpath-link=$(STAGING_DIR)/opt/lib $(if $(ICONV_FULL),-liconv)
EXTRA_CXXFLAGS += $(if $(CONFIG_GCC_VERSION_4_8),-std=gnu++11,-std=gnu++14)

CONFIGURE_ARGS += \
	$(call autoconf_bool,CONFIG_IPV6,ipv6) \
	--disable-debug \
	--disable-documentation \
	--disable-test \
	--disable-werror \
	\
	--disable-ao \
	--disable-bzip2 \
	--disable-fluidsynth \
	--disable-wildmidi \
	--disable-gme \
	--enable-inotify \
	--disable-icu \
	--disable-eventfd \
	--disable-iso9660 \
	--disable-jack \
	--disable-roar \
	--disable-libwrap \
	--disable-lsr \
	--disable-mikmod \
	--disable-modplug \
	--disable-mpc \
	--disable-mpg123 \
	--disable-openal \
	--disable-opus \
	--disable-pulse \
	--disable-sidplay \
	--disable-solaris-output \
	--disable-sqlite \
	--disable-lame-encoder \
	--disable-twolame-encoder \
	--disable-shine-encoder \
	--enable-wave-encoder \
	--disable-wavpack \
	--disable-wildmidi \
	--disable-zzip \
	--with-zeroconf=no \
	--disable-soxr \
	\
	--enable-curl \
	--enable-flac \
	--enable-httpd-output \
	$(call autoconf_bool,CONFIG_BUILD_PATENTED,mad) \
	$(call autoconf_bool,CONFIG_AUDIO_SUPPORT,alsa) \
	--enable-tcp \
	--enable-un \
	--disable-epoll \
	--disable-signalfd \
	--disable-soundcloud

CONFIGURE_VARS += \
	FLAC_CFLAGS="$(TARGET_CFLAGS) -I$(STAGING_DIR)/opt/include/FLAC" \
	FLAC_LIBS="$(TARGET_LDFLAGS) -lFLAC" \
	$(if $(CONFIG_BUILD_PATENTED),MAD_CFLAGS="$(TARGET_CFLAGS)") \
	$(if $(CONFIG_BUILD_PATENTED),MAD_LIBS="$(TARGET_LDFLAGS) -lmad") \

ifeq ($(BUILD_VARIANT),full)

  CONFIGURE_ARGS += \
	--enable-upnp \
	$(call autoconf_bool,CONFIG_BUILD_PATENTED,aac) \
	--enable-audiofile \
	--enable-fifo \
	--enable-ffmpeg \
	--enable-id3 \
	--enable-lastfm \
	--enable-mms \
	--enable-flac \
	--enable-pipe-output \
	--enable-recorder-output \
	--disable-shout \
	--enable-sndfile \
	--enable-vorbis \
	--disable-vorbis-encoder \
	--with-faad="$(STAGING_DIR)/opt" \
	--with-tremor=yes \

endif

ifeq ($(BUILD_VARIANT),mini)

  # oggflac is not compatible with tremor
  CONFIGURE_ARGS += \
	--disable-upnp \
	--disable-aac \
	--disable-audiofile \
	--disable-fifo \
	--disable-ffmpeg \
	--disable-id3 \
	--disable-mms \
	--disable-pipe-output \
	--disable-recorder-output \
	--disable-shout \
	--disable-sndfile \
	--disable-vorbis \
	--disable-vorbis-encoder \
	--with-tremor=yes \

endif

define Package/mpd-zyx/install
	$(INSTALL_DIR) $(1)/opt/bin
	$(INSTALL_DIR) $(1)/opt/var/music
	$(INSTALL_BIN) $(PKG_INSTALL_DIR)/opt/bin/mpd $(1)/opt/bin/
	$(INSTALL_DIR) $(1)/opt/etc
	$(INSTALL_CONF) ./files/mpd.conf $(1)/opt/etc/
	$(INSTALL_DIR) $(1)/opt/etc/init.d
	$(INSTALL_BIN) ./files/S89mpd $(1)/opt/etc/init.d/
endef

define Package/mpd-full-zyx/install
$(call Package/mpd-zyx/install,$1)
endef

define Package/mpd-mini-zyx/install
$(call Package/mpd-zyx/install,$1)
endef

define Package/mpd-avahi-service-zyx/install
	$(INSTALL_DIR) $(1)/opt/etc/avahi/services
	$(INSTALL_DATA) ./files/mpd.service $(1)/opt/etc/avahi/services/
endef

$(eval $(call BuildPackage,mpd-full-zyx))
$(eval $(call BuildPackage,mpd-mini-zyx))
$(eval $(call BuildPackage,mpd-avahi-service-zyx))
